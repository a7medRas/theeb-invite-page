<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>كود الدعوة - حدث خاص</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f6f7fb;
      --card: #fff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #a67c52;         /* ذهبي */
      --accent-dark: #8c6b44;
      --ok: #1b5e20;
      --border: #e5e7eb;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius-lg: 22px;
      --radius-md: 14px;

      --bar-bg:#fff;
      --bar-text:#111;
      --coin:#f2c94c;
      --coin-shadow:rgba(0,0,0,.15);
    }
    /* وضع ليلي */
    body.dark{
      --bg:#0f172a;
      --card:#0b1224;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#d6a65c;
      --accent-dark:#b1843f;
      --ok:#34d399;
      --border:#1e293b;
      --bar-bg:#0b1224;
      --bar-text:#e5e7eb;
      --coin:#ffd166;
      --coin-shadow:rgba(255,209,102,.25);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{min-height:100%;font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text)}
    body{display:flex;align-items:flex-start;justify-content:center}
    .wrap{width:min(1040px,94%); margin:18px auto 100px;}

    /* شريط العداد + تبديل الليلي */
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background:var(--bar-bg); border:1px solid var(--border);
      border-radius:16px; box-shadow:var(--shadow); padding:10px 14px; margin-bottom:16px;
      position:sticky; top:10px; z-index:5;
    }
    .counter{
      display:flex; align-items:center; gap:10px;
    }
    .coin{
      width:34px;height:34px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fff7d1, var(--coin));
      box-shadow:0 4px 10px var(--coin-shadow);
      animation:spin 2s linear infinite;
    }
    @keyframes spin{ 0%{transform:rotateY(0)} 50%{transform:rotateY(180deg)} 100%{transform:rotateY(360deg)} }
    .amount{font-size:20px;font-weight:800;color:var(--bar-text)}
    .amount small{font-weight:600;color:var(--muted);margin-inline-start:6px}
    .toggle{
      display:flex; align-items:center; gap:8px;
    }
    .toggle button{
      background:var(--accent); color:#fff; border:none; border-radius:999px; padding:8px 12px; cursor:pointer;
    }

    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius-lg); box-shadow:var(--shadow);
      padding:24px 20px; margin-top:8px;
    }

    .h1{font-size:clamp(22px,3.2vw,30px); font-weight:800; text-align:center; margin-bottom:10px;}
    .lead{text-align:center; color:var(--muted); line-height:1.9; font-size:clamp(14px,2.2vw,16px); margin-bottom:18px;}
    .subhead{text-align:center; font-weight:700; margin:8px 0 12px; color:var(--text);}

    /* جدول */
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; margin:10px 0 18px; border:1px solid var(--border)}
    th,td{padding:12px 12px; border-bottom:1px solid var(--border)}
    th{background:var(--accent); color:#fff; font-weight:700}
    tr:last-child td{border-bottom:none}
    td{background:var(--card); color:var(--text)}

    /* إدخال وزر */
    .field{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:6px}
    .input{flex:1 1 340px; max-width:520px; padding:14px 16px; border:1px solid var(--border); border-radius:999px; background:#fff; font-size:18px; text-align:center; color:#111;}
    body.dark .input{background:#0f172a;color:#e5e7eb;border-color:#1e293b}
    .input::placeholder{color:#9ca3af}
    .btn{padding:12px 20px; border:none; border-radius:999px; cursor:pointer; background:var(--accent); color:#fff; font-size:16px; font-weight:700; transition:filter .15s ease;}
    .btn:hover{filter:brightness(1.05)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .hint{font-size:13px; color:var(--muted); text-align:center; margin-top:8px}
    .cooldown{font-size:13px; color:var(--accent-dark); text-align:center; margin-top:6px; display:none}

    /* كارت الدعوة */
    #inviteCard{display:none; margin-top:18px; background:#faf8f4; border:1px solid #eadfce; border-radius:18px; padding:18px 16px; box-shadow:0 8px 22px rgba(0,0,0,.06)}
    body.dark #inviteCard{background:#111827;border-color:#283145}
    .code{font-size:24px; font-weight:800; color:var(--ok); direction:ltr; text-align:center; margin-bottom:10px}
    .row{display:flex; align-items:center; gap:14px; flex-wrap:wrap; justify-content:center}
    .qr-box{background:#fff; border:1px solid #e9e2d8; border-radius:14px; padding:12px; width:180px;height:180px; display:flex; align-items:center; justify-content:center}
    body.dark .qr-box{background:#0f172a;border-color:#1e293b}
    .preview{flex:1; min-width:260px; display:flex; flex-direction:column; gap:10px; max-width:520px}
    .preview-link{background:#fff; border:1px dashed #d6c7b6; border-radius:12px; padding:12px 10px; color:#111; font-size:14px; line-height:1.6; word-break:break-all; direction:ltr}
    body.dark .preview-link{background:#0f172a;border-color:#374151;color:#e5e7eb}
    .tools .mini, .share .mini{background:#5e5e5e; color:#fff; border:none; border-radius:10px; padding:9px 14px; font-size:14px; cursor:pointer}
    .tools .mini:hover, .share .mini:hover{filter:brightness(1.08)}
    .tools .mini.primary{background:var(--accent)}
    #shareCounter{color:var(--muted); font-size:14px; text-align:center; margin-top:8px}

    /* عناوين الأقسام */
    .sec-title{text-align:center; font-weight:800; font-size:clamp(18px,2.6vw,22px); margin:18px 0 10px; color:var(--text);}

    /* ألوان النسب في جدول المكافآت الإضافية */
    .bonus table th, .bonus table td{text-align:center;}
    .bonus tbody tr td:last-child {font-weight: 800; border-radius: 6px;}
    .bonus tbody tr:nth-child(1) td:last-child {background: #e8f5e9; color: #2e7d32;}
    .bonus tbody tr:nth-child(2) td:last-child {background: #e3f2fd; color: #1565c0;}
    .bonus tbody tr:nth-child(3) td:last-child {background: #fff3e0; color: #ef6c00;}
    .bonus tbody tr:nth-child(4) td:last-child {background: #f3e5f5; color: #6a1b9a;}
    .bonus tbody tr:nth-child(5) td:last-child {background: #fff8e1; color: #b28900;}

    /* ===== محاكي الأرباح ===== */
    .sim{
      margin-top:26px; background:var(--card); border:1px solid var(--border);
      border-radius:18px; padding:18px 16px;
    }
    .sim .controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:10px}
    .sim .input{flex:1 1 220px; max-width:280px}
    .sim .grid{
      display:grid; grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px; margin-top:10px
    }
    .stat{
      background:#fafafa; border:1px dashed #e5e7eb; border-radius:12px; padding:10px;
      text-align:center; font-size:14px; color:#111;
    }
    body.dark .stat{background:#0f172a;border-color:#334155;color:#e5e7eb}
    .stat b{display:block; font-size:18px; margin-top:6px}
    .chart-wrap{margin-top:14px; background:var(--card); border:1px solid var(--border); border-radius:14px; padding:10px}

    /* ===== Modal البوستر ===== */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:20}
    .modal .box{background:var(--card); border-radius:16px; padding:14px; width:min(900px,95%); border:1px solid var(--border)}
    .modal .head{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
    .modal .head h4{margin:0; font-size:18px}
    .modal .btns{display:flex; gap:8px}
    .x{background:#e11d48; color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer}
    .ghost{background:#5e5e5e; color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer}
    .gold{background:var(--accent); color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer}
    .poster-wrap{display:flex; justify-content:center; align-items:center; padding:6px}
    canvas.poster{width:100%; height:auto; background:#fff; border-radius:10px}

    /* Toast */
    .toast{position:fixed; top:16px; right:16px; background:#111c; color:#fff; padding:10px 14px; border-radius:12px; font-size:14px; opacity:0; transform:translateY(-8px); transition:all .25s ease; z-index:30}
    .toast.show{opacity:1; transform:translateY(0)}

    /* إنجازات */
    .achv{margin-top:18px; background:var(--card); border:1px dashed var(--border); border-radius:16px; padding:14px}
    .achv-list{display:grid; grid-template-columns:repeat(auto-fit,minmax(190px,1fr)); gap:10px}
    .badge{
      display:flex; align-items:center; gap:10px; border:1px solid var(--border); border-radius:12px; padding:10px; background:rgba(166,124,82,.06)
    }
    .badge.lock{opacity:.6; filter:grayscale(1)}
    .badge .emoji{font-size:20px}
    .badge .t{font-size:14px}
    .badge .t small{display:block;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- TOP BAR: العداد + وضع ليلي -->
    <div class="topbar">
      <div class="counter">
        <div class="coin" aria-hidden="true"></div>
        <div class="amount" id="liveAmount">0 <small>USD</small></div>
      </div>
      <div class="toggle">
        <span style="color:var(--muted)">الوضع</span>
        <button id="darkToggle">🌙/☀️ تبديل</button>
      </div>
    </div>

    <div class="card">
      <h1 class="h1">احصل على كود الدعوة الخاص بك 🎉</h1>
      <p class="lead">
        هذا الحدث متاح لجميع مذيعين الوكالة. يمكن لكل مذيع الحصول
        على كود دعوة خاصة به ودعوة أشخاص جدد والحصول على مكافآت تصل
        إلى <b>$1000</b> شهريًا.
      </p>
      <div class="subhead">شروط الحصول على المكافأة:</div>
      <p class="lead" style="margin-top:-4px">
        1- أن يجتاز المذيع المدعو مرحلة الأوديشن. <br>
        2- أن يحقق 31 ساعة خلال أول شهر.
      </p>

      <!-- الجدول الأساسي -->
      <table aria-label="جدول المكافآت">
        <thead><tr><th>نوع الدعوة</th><th>المكافأة</th></tr></thead>
        <tbody>
          <tr><td>مذيع من داخل الشرق الأوسط</td><td>2$</td></tr>
          <tr><td>مذيع من دول الخليج</td><td>4$</td></tr>
        </tbody>
      </table>

      <!-- جدول المكافآت الإضافية -->
      <section class="bonus">
        <h3 class="sec-title">المكافآت الإضافية – نسبة من تارجيت المدعو</h3>
        <p class="lead" style="margin-top:-4px; text-align:center">
          يحصل الداعي على مكافأة لمدة <b>3 شهور متتالية</b> في حال قام المذيع المدعو
          بتحقيق التارجيت بنفسه، تصل المكافأة إلى <b>25%</b>.
        </p>
        <table aria-label="جدول نسب المكافآت الإضافية">
          <thead><tr><th>شريحة التارجيت (USD)</th><th>نسبة المكافأة للداعي</th></tr></thead>
          <tbody>
            <tr><td>من 2,000 إلى 50,000</td><td>2%</td></tr>
            <tr><td>من 80,000 إلى 220,000</td><td>8%</td></tr>
            <tr><td>من 300,000 إلى 800,000</td><td>15%</td></tr>
            <tr><td>من 1,000,000 إلى 5,000,000</td><td>20%</td></tr>
            <tr><td>من 6,500,000 إلى 10,000,000</td><td>25%</td></tr>
          </tbody>
        </table>
        <p class="hint">* تُحتسب النسبة على التارجيت الشهري، وتصرف لمدة 3 شهور متتالية طالما استوفى المدعو الشروط.</p>
      </section>

      <!-- إدخال الكود -->
      <div class="field">
        <input id="likeeId" class="input" placeholder="اكتب Likee ID — حروف وأرقام إنجليزية فقط (3 رموز+)" inputmode="latin" autocomplete="off" />
        <button id="genBtn" class="btn" onclick="generateCode()">احصل على الكود</button>
      </div>
      <p class="hint">أمثلة صالحة: <span dir="ltr">adam123</span> • <span dir="ltr">L1K33Star9</span></p>
      <div id="cooldownHint" class="cooldown"></div>

      <!-- كارت الدعوة -->
      <section id="inviteCard" aria-live="polite">
        <div class="code" id="inviteCode"></div>
        <div class="row" style="margin-bottom:8px">
          <div class="qr-box"><img id="qrImg" alt="QR" width="160" height="160" /></div>
          <div class="preview">
            <div id="inviteLinkPreview" class="preview-link"></div>
            <div class="row tools">
              <button class="mini primary" onclick="copyCode()">📋 نسخ الكود</button>
              <button class="mini primary" onclick="copyLink()">🔗 نسخ الرابط</button>
              <button class="mini" onclick="downloadCard()">⬇️ تحميل الكارت PNG</button>
              <button class="mini" onclick="openPoster()">🖼️ إنشاء بوستر</button>
            </div>
          </div>
        </div>
        <div class="row share">
          <button class="mini" onclick="share('whatsapp')">واتساب</button>
          <button class="mini" onclick="share('telegram')">تيليجرام</button>
          <button class="mini" onclick="share('messenger')">ماسنجر</button>
          <button class="mini" onclick="share('copy')">نسخ النص</button>
        </div>
        <p id="shareCounter"></p>
      </section>

      <!-- محاكي الأرباح الفوري -->
      <section class="sim" id="sim">
        <h3 class="sec-title">محاكي الأرباح الفوري</h3>
        <div class="controls">
          <input id="simCount" class="input" type="number" min="1" placeholder="عدد المدعوين (مثال: 5)" />
          <input id="simTarget" class="input" type="number" min="0" step="100" placeholder="متوسط التارجيت لكل مدعو (USD)" />
          <button class="btn" onclick="runSimulator(true)">احسب الآن</button>
        </div>
        <p class="hint">* حساب تقريبي يعتمد على الجدول بالأعلى ويفترض أن كل المدعوين يحققون نفس المتوسط.</p>
        <div class="grid">
          <div class="stat">النسبة المطبقة <b id="simPercent">—</b></div>
          <div class="stat">العائد الشهري المتوقع <b id="simMonthly">—</b></div>
          <div class="stat">إجمالي 3 شهور <b id="simQuarter">—</b></div>
          <div class="stat">عدد المدعوين × المتوسط <b id="simVolume">—</b></div>
        </div>
        <div class="chart-wrap">
          <canvas id="earnChart" height="140" aria-label="الرسم البياني للأرباح"></canvas>
        </div>
      </section>

      <!-- إنجازات -->
      <section class="achv">
        <h3 class="sec-title">الإنجازات</h3>
        <div class="achv-list" id="achvList">
          <div class="badge lock" data-key="first_code"><div class="emoji">🎯</div><div class="t">أول كود<div><small>ولّد أول كود دعوة</small></div></div></div>
          <div class="badge lock" data-key="ten_codes"><div class="emoji">💪</div><div class="t">10 أكواد<div><small>ولّد 10 أكواد دعوة</small></div></div></div>
          <div class="badge lock" data-key="sim_used"><div class="emoji">📊</div><div class="t">أول محاكاة<div><small>شغّل محاكي الأرباح</small></div></div></div>
        </div>
      </section>
    </div>

    <!-- Poster Modal -->
    <div class="modal" id="posterModal" role="dialog" aria-modal="true" aria-labelledby="posterTitle">
      <div class="box">
        <div class="head">
          <h4 id="posterTitle">بوستر الدعوة الشخصي (1080×1080)</h4>
          <div class="btns">
            <button class="ghost" onclick="regenPoster()">تحديث</button>
            <button class="gold" onclick="downloadPoster()">تنزيل PNG</button>
            <button class="x" onclick="closePoster()">إغلاق</button>
          </div>
        </div>
        <div class="poster-wrap">
          <canvas id="posterCanvas" class="poster" width="1080" height="1080"></canvas>
        </div>
      </div>
    </div>

    <!-- دليل النجاح -->
    <div class="card" style="margin-top:16px">
      <h3 class="sec-title">📚 دليل النجاح السريع</h3>
      <ul style="line-height:2; color:var(--muted); font-size:15px; padding-inline:18px">
        <li>اكتب رسالة قصيرة وواضحة عند إرسال الرابط، وحطّ الكود في أول السطر.</li>
        <li>انشر البوستر في أوقات الذروة (8–10م) واطلب من المدعو حفظه.</li>
        <li>ذكّر المدعو بتحقيق شروط المكافأة (الأوديشن + 31 ساعة).</li>
        <li>استخدم محاكي الأرباح لتحديد هدف شهري واقعي لك ولفريقك.</li>
      </ul>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- مكتبات -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    const $ = s => document.querySelector(s);
    const liveAmountEl = $("#liveAmount");
    const darkToggle = $("#darkToggle");
    const likeeInput = $("#likeeId");
    const genBtn = $("#genBtn");
    const inviteCard = $("#inviteCard");
    const codeArea = $("#inviteCode");
    const linkPreview = $("#inviteLinkPreview");
    const qrImg = $("#qrImg");
    const cooldownHint = $("#cooldownHint");
    const toastEl = $("#toast");

    // Simulator elements
    const simCount = $("#simCount");
    const simTarget = $("#simTarget");
    const simPercent = $("#simPercent");
    const simMonthly = $("#simMonthly");
    const simQuarter = $("#simQuarter");
    const simVolume = $("#simVolume");
    let earnChart;

    // Poster elements
    const posterModal = $("#posterModal");
    const posterCanvas = $("#posterCanvas");
    const pctx = posterCanvas.getContext("2d");

    // إنجازات
    const achvList = $("#achvList");

    let counter = 0;          // عدد الأكواد المعروضة
    let lastGenTime = 0;
    const COOLDOWN = 5;
    let liveEarnings = 0;     // إجمالي الأرباح المتراكمة

    /* ====== وضع ليلي ====== */
    (function initTheme(){
      const saved = localStorage.getItem('theme') || 'light';
      if(saved === 'dark') document.body.classList.add('dark');
      darkToggle.onclick = ()=>{
        document.body.classList.toggle('dark');
        localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
      };
    })();

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 1700);
    }

    // إدخال Likee: حروف/أرقام إنجليزية فقط
    likeeInput.addEventListener('input', () => {
      const cleaned = (likeeInput.value || '')
        .replace(/\s+/g,'')
        .replace(/[^A-Za-z0-9]/g,'');
      if(cleaned !== likeeInput.value) likeeInput.value = cleaned;
    });

    (function init(){
      try{
        const saved = localStorage.getItem('likeeId');
        if(saved) likeeInput.value = saved;
      }catch(e){}
      const p = new URLSearchParams(location.search);
      const urlCode = p.get('code');
      if(urlCode) showResult(urlCode);

      // استرجاع أرباح حية محفوظة
      const savedAmount = parseFloat(localStorage.getItem('liveEarnings') || '0');
      if(savedAmount>0){ liveEarnings = savedAmount; renderAmount(); }

      // استرجاع إنجازات
      refreshAchievementsUI();

      // Init empty chart
      buildChart([0,0,0,0], ['شهر 1','شهر 2','شهر 3','الإجمالي']);
    })();

    function validateId(id){ return /^[A-Za-z0-9]{3,}$/.test(id); }
    function rand4(){ return Math.floor(1000 + Math.random()*9000); }
    function inviteLink(inviteCode){ const base = location.origin + location.pathname; return base + '?code=' + encodeURIComponent(inviteCode); }

    function startCooldown(){
      const start = Date.now();
      genBtn.disabled = true; cooldownHint.style.display = 'block';
      const tick = () => {
        const remain = Math.max(0, COOLDOWN - Math.floor((Date.now()-start)/1000));
        cooldownHint.textContent = '⏳ الرجاء الانتظار ' + remain + ' ث قبل توليد كود جديد.';
        if(remain <= 0){ genBtn.disabled = false; cooldownHint.style.display = 'none'; }
        else setTimeout(tick, 250);
      }; tick();
    }

    function generateCode(){
      const now = Date.now();
      if(now - lastGenTime < COOLDOWN*1000){ startCooldown(); toast('انتظر قليلًا…'); return; }
      const id = (likeeInput.value || '').trim();
      if(!validateId(id)){ toast('❌ Likee ID يجب أن يكون حروف/أرقام إنجليزية فقط وبحد أدنى 3 رموز.'); likeeInput.focus(); return; }
      try{ localStorage.setItem('likeeId', id); }catch(e){}
      const code = `TH-${id}-${rand4()}`;
      showResult(code);
      sendToGoogleSheet(id, code);
      lastGenTime = now; startCooldown();

      // إنجاز: أول كود + 10 أكواد
      unlockAchievement('first_code');
      if(counter >= 10) unlockAchievement('ten_codes');
    }

    function showResult(code){
      codeArea.textContent = code;
      const link = inviteLink(code);
      linkPreview.textContent = link;
      qrImg.src = "https://api.qrserver.com/v1/create-qr-code/?size=170x170&data=" + encodeURIComponent(link);
      qrImg.alt = "QR to " + link;
      inviteCard.style.display = 'block';
      incrementCounter();
    }

    function incrementCounter(){ counter++; $("#shareCounter").innerText = `💡 عدد الأكواد التي تم إنشاؤها/عرضها: ${counter}`; }

    function copyText(t){ navigator.clipboard.writeText(t).then(()=>toast('تم النسخ ✅')); }
    function copyCode(){ const c = codeArea.textContent.trim(); if(c) copyText(c); }
    function copyLink(){ const l = linkPreview.textContent.trim(); if(l) copyText(l); }

    function share(platform){
      const c = codeArea.textContent.trim();
      const l = linkPreview.textContent.trim();
      const text = `📢 كود الدعوة الخاص بي: ${c}\nانضم الآن إلى الحدث!\n${l}`;
      let url = "";
      switch(platform){
        case "whatsapp": url = `https://wa.me/?text=${encodeURIComponent(text)}`; break;
        case "telegram": url = `https://t.me/share/url?url=${encodeURIComponent(l)}&text=${encodeURIComponent('انضم الآن! ' + c)}`; break;
        case "messenger": url = `fb-messenger://share/?link=${encodeURIComponent(l)}&app_id=0`; break;
        case "copy": copyText(text); return;
      }
      window.open(url, '_blank');
    }

    // حفظ الكارت كصورة
    async function downloadCard(){
      try{
        const node = document.getElementById('inviteCard');
        const canvas = await html2canvas(node, {scale:2, useCORS:true});
        const dataURL = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        const name = (codeArea.textContent || 'invite').replace(/\s+/g,'');
        a.href = dataURL; a.download = name + '.png'; a.click();
      }catch(e){ toast('تعذر حفظ الصورة، حاول مجددًا'); }
    }

    function sendToGoogleSheet(likeeId, inviteCode) {
      fetch("https://script.google.com/macros/s/AKfycbwtnLPgvBZJ35GlA75TejT4eQVNPQaWRmBD2r4YvRqNCwY91HF3AXiPn4udTANT4zwv/exec", {
        method: "POST",
        body: new URLSearchParams({ likeeId, inviteCode })
      }).then(r=>r.text()).catch(()=>{});
    }

    /* ===================== Earnings Simulator ===================== */
    function getPercentByTarget(t){
      if(t >= 6500000 && t <= 10000000) return 0.25;
      if(t >= 1000000 && t <= 5000000)  return 0.20;
      if(t >= 300000 && t <= 800000)    return 0.15;
      if(t >= 80000  && t <= 220000)    return 0.08;
      if(t >= 2000   && t <= 50000)     return 0.02;
      return 0; // خارج الشرائح المحددة
    }

    function fmtUSD(n){
      try{
        return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n||0);
      }catch(e){ return (n||0).toLocaleString() + ' $'; }
    }

    // addToCounterOnRun: لما true يضيف الناتج للعداد الحي تلقائيًا
    function runSimulator(addToCounterOnRun=false){
      const count = Math.max(0, parseInt(simCount.value || '0', 10));
      const target = Math.max(0, parseFloat(simTarget.value || '0'));
      if(!count || !target){
        simPercent.textContent='—'; simMonthly.textContent='—'; simQuarter.textContent='—'; simVolume.textContent='—';
        buildChart([0,0,0,0]); return;
      }

      const pct = getPercentByTarget(target);
      const monthly = count * target * pct;
      const quarter = monthly * 3;
      const volume  = count * target;

      simPercent.textContent = pct ? (pct*100).toFixed(0) + '%' : 'خارج الشرائح';
      simMonthly.textContent = fmtUSD(monthly);
      simQuarter.textContent = fmtUSD(quarter);
      simVolume.textContent  = fmtUSD(volume);

      buildChart([monthly, monthly, monthly, quarter], ['شهر 1','شهر 2','شهر 3','الإجمالي']);

      // إنجاز: أول استخدام للمحاكي
      unlockAchievement('sim_used');

      // تزامن تلقائي مع العداد الحي (نضيف العائد الشهري لمرّة واحدة لكل حساب)
      if(addToCounterOnRun && monthly>0){
        addEarnings(monthly);
      }
    }

    function buildChart(data, labels=['شهر 1','شهر 2','شهر 3','الإجمالي']){
      const ctx = document.getElementById('earnChart');
      if(earnChart){ earnChart.destroy(); }
      earnChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'الأرباح (USD)', data }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { callback: v => fmtUSD(v).replace('$','') + ' $' } } }
        }
      });
    }

    /* ===================== Live Earnings Counter ===================== */
    function renderAmount(){
      liveAmountEl.innerHTML = Math.round(liveEarnings).toLocaleString('en-US') + ' <small>USD</small>';
    }
    function animateTo(target){
      const start = liveEarnings;
      const diff = target - start;
      const dur = 800; // ms
      const t0 = performance.now();
      function step(t){
        const p = Math.min(1, (t - t0)/dur);
        liveEarnings = start + diff * (0.5 - Math.cos(Math.PI*p)/2); // ease-in-out
        renderAmount();
        if(p<1) requestAnimationFrame(step);
        else { localStorage.setItem('liveEarnings', String(liveEarnings)); }
      }
      requestAnimationFrame(step);
    }
    function addEarnings(amount){
      if(!amount || amount<=0) return;
      animateTo(liveEarnings + amount);
      // نبضة على العملة
      const coin = document.querySelector('.coin');
      coin.style.transform = 'scale(1.25)';
      setTimeout(()=>coin.style.transform='', 220);
    }

    /* ===================== Poster Generator (1080x1080) ===================== */
    function openPoster(){
      if(!codeArea.textContent.trim()){ toast('ولّد الكود أولًا'); return; }
      posterModal.style.display = 'grid';
      regenPoster();
    }
    function closePoster(){ posterModal.style.display = 'none'; }
    function regenPoster(){
      const code = codeArea.textContent.trim();
      const link = linkPreview.textContent.trim();
      const id   = (likeeInput.value || '').trim();
      drawPoster({code, link, id});
    }
    function downloadPoster(){
      const a = document.createElement('a');
      a.href = posterCanvas.toDataURL('image/png');
      a.download = (codeArea.textContent.trim() || 'invite') + '-poster.png';
      a.click();
    }

    function drawPoster({code, link, id}){
      const w = posterCanvas.width, h = posterCanvas.height;
      // خلفية احترافية: Gradient + حلقات شفافة
      const g = pctx.createLinearGradient(0,0,w,h);
      g.addColorStop(0,'#1f2937'); g.addColorStop(0.6,'#2b3545'); g.addColorStop(1,'#3c3f4a');
      pctx.fillStyle = g; pctx.fillRect(0,0,w,h);
      pctx.globalAlpha = 0.08;
      pctx.strokeStyle = '#fff'; pctx.lineWidth = 2;
      for(let r=520; r>60; r-=50){ pctx.beginPath(); pctx.arc(w/2, h/2, r, 0, Math.PI*2); pctx.stroke(); }
      pctx.globalAlpha = 1;

      // شريط علوي ذهبي
      pctx.fillStyle = '#a67c52'; pctx.fillRect(0,0,w,110);
      pctx.fillStyle = '#fff'; pctx.font = 'bold 46px Cairo'; pctx.textAlign = 'center';
      pctx.fillText('دعوتك الخاصّة', w/2, 72);

      // بطاقة وسط
      const cardSize = w - 200; // 880
      const cardX = (w - cardSize)/2, cardY = 150;
      pctx.fillStyle = '#ffffff';
      roundRect(pctx, cardX, cardY, cardSize, cardSize - 80, 28, true, false);

      // الكود
      pctx.fillStyle = '#1b5e20'; pctx.font = '700 62px Cairo'; pctx.textAlign = 'center';
      pctx.fillText(code || 'TH-XXXX-1234', w/2, cardY + 115);

      // Likee ID
      pctx.fillStyle = '#4b5563'; pctx.font = '600 30px Cairo';
      pctx.fillText(id ? ('Likee ID: ' + id) : 'Likee ID', w/2, cardY + 165);

      // QR
      const qrSize = 360, qrX = w/2 - qrSize/2, qrY = cardY + 210;
      const qr = new Image(); qr.crossOrigin = 'anonymous';
      qr.onload = ()=>{
        pctx.drawImage(qr, qrX, qrY, qrSize, qrSize);
        // الرابط
        pctx.fillStyle = '#111'; pctx.font = '600 26px Cairo';
        wrapText(pctx, link || 'https://your-link', w/2, qrY + qrSize + 50, cardSize - 160, 34);
        // عبارة
        pctx.fillStyle = '#6b7280'; pctx.font = '600 26px Cairo';
        pctx.fillText('شارك الكود والرابط – أرباحك تبدأ من هنا ✨', w/2, cardY + cardSize - 42);
      };
      qr.src = "https://api.qrserver.com/v1/create-qr-code/?size="+qrSize+"x"+qrSize+"&data=" + encodeURIComponent(link || code || '');
    }

    function roundRect(ctx, x, y, w, h, r, fill=true, stroke=false){
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
      if(fill) ctx.fill();
      if(stroke) ctx.stroke();
    }

    function wrapText(ctx, text, centerX, startY, maxWidth, lineHeight){
      const words = (text || '').split(' ');
      let line = '', y = startY;
      ctx.textAlign = 'center';
      for(let n=0;n<words.length;n++){
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        if(metrics.width > maxWidth && n>0){
          ctx.fillText(line.trim(), centerX, y);
          line = words[n] + ' ';
          y += lineHeight;
        }else{
          line = testLine;
        }
      }
      ctx.fillText(line.trim(), centerX, y);
    }

    /* ===================== إنجازات ===================== */
    function refreshAchievementsUI(){
      const keys = ['first_code','ten_codes','sim_used'];
      keys.forEach(k=>{
        const el = achvList.querySelector(`[data-key="${k}"]`);
        const unlocked = localStorage.getItem('achv_'+k) === '1';
        el.classList.toggle('lock', !unlocked);
      });
    }
    function unlockAchievement(key){
      const storageKey = 'achv_'+key;
      if(localStorage.getItem(storageKey) === '1') return;
      localStorage.setItem(storageKey, '1');
      refreshAchievementsUI();
      toast('🏅 إنجاز جديد!');
    }

    /* ===================== Live amount formatting ===================== */
    function renderAmount(){
      document.getElementById('liveAmount').innerHTML = Math.round(liveEarnings).toLocaleString('en-US') + ' <small>USD</small>';
    }
    function animateTo(target){
      const start = liveEarnings;
      const diff = target - start;
      const dur = 800; // ms
      const t0 = performance.now();
      function step(t){
        const p = Math.min(1, (t - t0)/dur);
        liveEarnings = start + diff * (0.5 - Math.cos(Math.PI*p)/2); // ease in/out
        renderAmount();
        if(p<1) requestAnimationFrame(step);
        else localStorage.setItem('liveEarnings', String(liveEarnings));
      }
      requestAnimationFrame(step);
    }
    function addEarnings(amount){
      if(!amount || amount<=0) return;
      animateTo(liveEarnings + amount);
      const coin = document.querySelector('.coin');
      coin.style.transform = 'scale(1.25)';
      setTimeout(()=>coin.style.transform='', 220);
    }

    // ربط زر حساب المحاكي ليزامن العداد تلقائيًا (تم بتمرير true في runSimulator)
    // يمكنك أيضًا استدعاء addEarnings من أي مكان آخر عند الحاجة.

  </script>
</body>
</html>
